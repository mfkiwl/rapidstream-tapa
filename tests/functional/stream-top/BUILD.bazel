"""The test with streams as top-level args for TAPA."""

# Copyright (c) 2024 RapidStream Design Automation, Inc. and contributors.
# All rights reserved. The contributor(s) of this file has/have agreed to the
# RapidStream Contributor License Agreement.

load("@rules_cc//cc:defs.bzl", "cc_binary")
load("//bazel:tapa_rules.bzl", "tapa_xo")

sh_test(
    name = "stream-top",
    size = "medium",
    srcs = ["//bazel:v++_env.sh"],
    args = ["$(location stream-top-host)"],
    data = [":stream-top-host"],
    env = {"TAPA_CONCURRENCY": "1"},
)

sh_test(
    name = "stream-top-xosim",
    size = "enormous",
    timeout = "moderate",
    srcs = ["//bazel:v++_env.sh"],
    args = [
        "$(location stream-top-host)",
        "--bitstream=$(location stream-top-xo)",
        "--xosim_executable=$(location //tapa/cosim:tapa-fast-cosim)",
    ],
    data = [
        ":stream-top-host",
        ":stream-top-xo",
        "//tapa/cosim:tapa-fast-cosim",
    ],
    tags = [
        "cpu:3",
    ],
)

tapa_xo(
    name = "stream-top-xo",
    src = "vadd.cpp",
    platform_name = "xilinx_u250_gen3x16_xdma_4_1_202210_1",
    top_name = "VecAdd",
)

cc_binary(
    name = "stream-top-host",
    srcs = glob([
        "*.cpp",
    ]),
    deps = [
        "//tapa-lib:tapa",
        "@gflags",
        "@vitis_hls//:include",
    ],
)

tapa_xo(
    name = "stream-top-hls",
    src = "vadd.cpp",
    platform_name = "xilinx_u250_gen3x16_xdma_4_1_202210_1",
    top_name = "VecAdd",
    vitis_mode = False,
)

sh_test(
    name = "stream-top-hls-sim",
    size = "enormous",
    timeout = "moderate",
    srcs = ["//bazel:v++_env.sh"],
    args = [
        # sh_test args are subject to shell tokenization:
        # https://bazel.build/reference/be/common-definitions#test.args
        "vivado",
        "-mode batch",
        "-source $(location :testbench/sim.tcl)",
        "-tclargs $(location :stream-top-hls)",
        "$(location :testbench/hls-stream-tb.sv)",
    ],
    data = [
        ":stream-top-hls",
        ":testbench/hls-stream-tb.sv",
        ":testbench/sim.tcl",
    ],
)
